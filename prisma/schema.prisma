generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(auto()) @map("_id") @db.ObjectId
  email              String              @unique
  username           String?             @unique
  usernameLower      String?             @unique
  name               String?
  firstName          String?
  lastName           String?
  password           String?
  phoneNumber        String?             @unique
  heardFrom          String?
  heardFromOther     String?
  googleId           String?
  profileImage       String?
  location           String?
  biography          String?
  relationshipStatus String?
  orientation        String?
  height             String?
  ethnicity          String?
  zodiacSign         String?
  favoriteColor      String?
  favoriteMedia      String?
  petOwnership       String?
  createdAt          DateTime            @default(now())
  PasswordResetToken PasswordResetToken[]
  appointments       Appointment[]       @relation("UserAppointments")
  sentMessages       Message[]           @relation("SentMessagesUser")
  receivedMessages   Message[]           @relation("ReceivedMessagesUser")
  conversations1     Conversation[]      @relation("User1Conversations")
  conversations2     Conversation[]      @relation("User2Conversations")
  posts              Post[]              @relation("UserPosts")
  replies            Reply[]             @relation("UserReplies")
  specialistApplication SpecialistApplication?
  isAdmin            Boolean             @default(false)
  status             String              @default("active")
  VideoSession       VideoSession[]
  ProfileVisit       ProfileVisit[]      @relation("Visitor")
  Proposal           Proposal[]          @relation
  reviews            Review[]            @relation("UserReviews")
  surveyResponses    SurveyResponse[]    @relation("UserSurveys")
  securityLogs       SecurityLog[]       @relation("UserSecurityLogs")
  reported           Report[]            @relation("ReportedUser")
  reports            Report[]            @relation("Reporter")
  notesAuthored      Note[]              @relation("AuthorNotes")
  notesReceived      Note[]              @relation("TargetUserNotes")
  profileVisits      ProfileVisit[]      @relation("VisitedUser")
  cart               Cart?
  orders             Order[]
  trainingVideoWatches TrainingVideoWatch[]
}

model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Appointment {
  id                   String         @id @default(auto()) @map("_id") @db.ObjectId
  userId               String?        @db.ObjectId
  specialistId         String         @db.ObjectId
  startTime            DateTime
  endTime              DateTime
  status               String         @default("upcoming")
  disputeStatus        String         @default("none")
  disputeReason        String?
  adminNotes           String?
  rate                 Float?
  adjustedRate         Float?
  modificationHistory  Json?
  venue                AppointmentVenue?
  createdAt            DateTime       @default(now())
  user                 User?          @relation("UserAppointments", fields: [userId], references: [id], onDelete: SetNull)
  specialist           Specialist     @relation("SpecialistAppointments", fields: [specialistId], references: [id], onDelete: Cascade)
  payment              Payment?

  @@index([specialistId, startTime, endTime])
}

model Conversation {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  userId1        String       @db.ObjectId
  userId2        String       @db.ObjectId
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user1          User         @relation("User1Conversations", fields: [userId1], references: [id], onDelete: Cascade)
  user2          User         @relation("User2Conversations", fields: [userId2], references: [id], onDelete: Cascade)
  messages       Message[]    @relation("ConversationMessages")
  readBy         Json?
  Proposal       Proposal[]   @relation
}

model Specialist {
  id                   String         @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  image                String?
  rating               Float?
  reviewCount          Int?
  rate                 Float?
  biography            String?
  companyCutPercentage Float?
  venue                VenueType      @default(both)
  createdAt            DateTime       @default(now())
  location             String?
  appointments         Appointment[]  @relation("SpecialistAppointments")
  application          SpecialistApplication? @relation
  VideoSession         VideoSession[]
  availability         Availability[] @relation
  profileVisits        ProfileVisit[] @relation("Visitee")
  Proposal             Proposal[]     @relation
  reviews              Review[]       @relation("SpecialistReviews")
  discounts            Discount[]     @relation
  reported             Report[]       @relation("ReportedSpecialist")
  notesReceived        Note[]         @relation("TargetSpecialistNotes")
}

model Post {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  content   String
  category  String
  authorId  String   @db.ObjectId
  author    User     @relation("UserPosts", fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  replies   Reply[]  @relation("PostReplies")
}

model Reply {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  content       String
  postId        String   @db.ObjectId
  authorId      String   @db.ObjectId
  parentReplyId String?  @db.ObjectId
  post          Post     @relation("PostReplies", fields: [postId], references: [id], onDelete: Cascade)
  author        User     @relation("UserReplies", fields: [authorId], references: [id], onDelete: Cascade)
  parentReply   Reply?   @relation("ReplyReplies", fields: [parentReplyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childReplies  Reply[]  @relation("ReplyReplies")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SpecialistApplication {
  id              String                @id @default(auto()) @map("_id") @db.ObjectId
  userId          String                @unique @db.ObjectId
  rate            Float
  venue           AppointmentVenue      // New field
  status          ProOnboardingStatus   @default(FORM_PENDING)
  submittedAt     DateTime?
  videoWatchedAt  DateTime?
  quizPassedAt    DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialist      Specialist?           @relation(fields: [specialistId], references: [id], onDelete: SetNull)
  specialistId    String?               @unique @db.ObjectId
  quizAttempts    ProQuizAttempt[]      @relation("ApplicationQuizAttempts")
  videoWatch      TrainingVideoWatch?   @relation("ProOnboardingVideo")

  @@index([status])
}

model ProQuizAttempt {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  applicationId   String                  @db.ObjectId
  score           Float
  passed          Boolean
  answers         Json
  attemptedAt     DateTime                @default(now())
  nextEligibleAt  DateTime?
  application     SpecialistApplication   @relation("ApplicationQuizAttempts", fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([nextEligibleAt])
}

enum ProOnboardingStatus {
  FORM_PENDING      // Form not submitted
  FORM_SUBMITTED    // Awaiting video
  VIDEO_PENDING     // Must watch video
  QUIZ_PENDING      // Video done, can take quiz
  QUIZ_PASSED       // â‰¥80%, awaiting admin
  QUIZ_FAILED       // <80%, on cooldown
  ADMIN_REVIEW      // Quiz passed, admin deciding
  APPROVED          // Professional!
  REJECTED          // Denied
}

model VideoSession {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  roomId        String      @unique
  userId        String      @db.ObjectId
  specialistId  String      @db.ObjectId
  date          DateTime
  time          String
  status        String      @default("upcoming")
  roomUrl       String?
  signalingData Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialist    Specialist  @relation(fields: [specialistId], references: [id], onDelete: Cascade)
}

model Availability {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  specialistId  String      @db.ObjectId
  dayOfWeek     Int
  slots         String[]
  breakDuration Int?        @default(30)
  specialist    Specialist  @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([specialistId, dayOfWeek], name: "specialistId_dayOfWeek")
}

model ProfileVisit {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  userId         String       @db.ObjectId
  specialistId   String?      @db.ObjectId
  visitedUserId  String?      @db.ObjectId
  createdAt      DateTime     @default(now())
  user           User         @relation("Visitor", fields: [userId], references: [id], onDelete: Cascade)
  specialist     Specialist?  @relation("Visitee", fields: [specialistId], references: [id], onDelete: SetNull)
  visitedUser    User?        @relation("VisitedUser", fields: [visitedUserId], references: [id], onDelete: SetNull)
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  text           String
  isAudio        Boolean      @default(false)
  isSystem       Boolean      @default(false)
  imageUrl       String?
  senderId       String       @db.ObjectId
  recipientId    String       @db.ObjectId
  conversationId String       @db.ObjectId
  createdAt      DateTime     @default(now())
  proposalId     String?      @db.ObjectId
  senderUser     User         @relation("SentMessagesUser", fields: [senderId], references: [id], onDelete: Cascade)
  recipientUser  User         @relation("ReceivedMessagesUser", fields: [recipientId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  proposal       Proposal?    @relation(fields: [proposalId], references: [id], onDelete: SetNull)
}

model Proposal {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  specialistId   String       @db.ObjectId
  userId         String       @db.ObjectId
  conversationId String       @db.ObjectId
  startTime      DateTime?
  endTime        DateTime?
  venue          AppointmentVenue?
  status         String       @default("pending")
  initiator      String       @default("specialist")
  createdAt      DateTime     @default(now())
  specialist     Specialist   @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  messages       Message[]    @relation

  @@index([specialistId, startTime, endTime])
}

model Review {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  specialistId String      @db.ObjectId
  reviewerId   String      @db.ObjectId
  rating       Int
  feedback     String
  createdAt    DateTime    @default(now())
  specialist   Specialist  @relation("SpecialistReviews", fields: [specialistId], references: [id], onDelete: Cascade)
  reviewer     User        @relation("UserReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
}

model Discount {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  specialistId String      @db.ObjectId
  name         String
  rate         Float
  discount     Float
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  specialist   Specialist  @relation(fields: [specialistId], references: [id], onDelete: Cascade)
}

model Payment {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  appointmentId  String?     @db.ObjectId @unique
  orderId        String?     @db.ObjectId @unique
  amount         Float
  status         String      @default("pending")
  stripeId       String?
  createdAt      DateTime    @default(now())
  notes          String?
  appointment    Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  order          Order?      @relation("OrderPayment", fields: [orderId], references: [id], onDelete: Cascade)
}

model CompanySettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SurveyResponse {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  rating    Int
  feedback  String?
  createdAt DateTime @default(now())
  user      User     @relation("UserSurveys", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

model SecurityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  eventType String
  ipAddress String?
  details   String
  timestamp DateTime @default(now())
  user      User?    @relation("UserSecurityLogs", fields: [userId], references: [id], onDelete: SetNull)
}

model Report {
  id                   String      @id @default(auto()) @map("_id") @db.ObjectId
  reporterId           String      @db.ObjectId
  reportedUserId       String?     @db.ObjectId
  reportedSpecialistId String?     @db.ObjectId
  reason               String
  details              String?
  status               String      @default("pending")
  createdAt            DateTime    @default(now())
  reporter             User        @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser         User?       @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)
  reportedSpecialist   Specialist? @relation("ReportedSpecialist", fields: [reportedSpecialistId], references: [id], onDelete: SetNull)
}

model Note {
  id                 String      @id @default(auto()) @map("_id") @db.ObjectId
  authorId           String      @db.ObjectId
  targetUserId       String?     @db.ObjectId
  targetSpecialistId String?     @db.ObjectId
  content            String
  createdAt          DateTime    @default(now())
  author             User        @relation("AuthorNotes", fields: [authorId], references: [id], onDelete: Cascade)
  targetUser         User?       @relation("TargetUserNotes", fields: [targetUserId], references: [id], onDelete: SetNull)
  targetSpecialist   Specialist? @relation("TargetSpecialistNotes", fields: [targetSpecialistId], references: [id], onDelete: SetNull)
}

enum VenueType {
  host
  visit
  both
}

enum AppointmentVenue {
  host
  visit
}

model Merchandise {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  image       String?
  stock       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[]
  cartItems   CartItem[]
}

model Cart {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  userId    String      @unique @db.ObjectId
  items     CartItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CartItem {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  cartId        String      @db.ObjectId
  merchandiseId String      @db.ObjectId
  quantity      Int
  cart          Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  merchandise   Merchandise @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)

  @@unique([cartId, merchandiseId])
}

model Order {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @db.ObjectId
  totalAmount Float
  status      String      @default("pending")
  stripeId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  payment     Payment?    @relation("OrderPayment")
}

model OrderItem {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String       @db.ObjectId
  merchandiseId String       @db.ObjectId
  quantity      Int
  price         Float
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  merchandise   Merchandise  @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)
}

model TrainingVideo {
  id                String                @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  url               String
  durationSec       Int?
  isActive          Boolean               @default(true)
  isProOnboarding   Boolean               @default(false)  // Flag for onboarding videos
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  watches           TrainingVideoWatch[]

  @@index([isActive])
}

model TrainingVideoWatch {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  userId          String                  @db.ObjectId
  videoId         String                  @db.ObjectId
  watchedSec      Int                     @default(0)
  isCompleted     Boolean                 @default(false)
  lastWatchedAt   DateTime                @updatedAt
  applicationId   String?                 @unique @db.ObjectId  // Scalar for 1-1 relation
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           TrainingVideo           @relation(fields: [videoId], references: [id], onDelete: Cascade)
  proApplication  SpecialistApplication?  @relation("ProOnboardingVideo", fields: [applicationId], references: [id], onDelete: SetNull)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}
