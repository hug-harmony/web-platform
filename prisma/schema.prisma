// schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  email          String  @unique
  username       String? @unique
  usernameLower  String? @unique
  name           String?
  firstName      String?
  lastName       String?
  password       String?
  phoneNumber    String?
  heardFrom      String?
  heardFromOther String?

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // OAuth Provider IDs
  googleId   String?
  appleId    String?
  facebookId String?

  primaryAuthMethod String? // "credentials" | "google" | "apple" | "facebook"

  profileImage       String?
  location           String?
  biography          String?
  relationshipStatus String?
  orientation        String?
  height             String?
  ethnicity          String?
  zodiacSign         String?
  favoriteColor      String?
  favoriteMedia      String?
  petOwnership       String?
  createdAt          DateTime  @default(now())
  lastOnline         DateTime?
  isAdmin            Boolean   @default(false)
  status             String    @default("active")

  // Relations
  PasswordResetToken      PasswordResetToken[]
  appointments            Appointment[]            @relation("UserAppointments")
  sentMessages            Message[]                @relation("SentMessagesUser")
  receivedMessages        Message[]                @relation("ReceivedMessagesUser")
  conversations1          Conversation[]           @relation("User1Conversations")
  conversations2          Conversation[]           @relation("User2Conversations")
  posts                   Post[]                   @relation("UserPosts")
  replies                 Reply[]                  @relation("UserReplies")
  professionalApplication ProfessionalApplication?
  VideoSession            VideoSession[]
  ProfileVisit            ProfileVisit[]           @relation("Visitor")
  Proposal                Proposal[]               @relation
  reviews                 Review[]                 @relation("UserReviews")
  surveyResponses         SurveyResponse[]         @relation("UserSurveys")
  securityLogs            SecurityLog[]            @relation("UserSecurityLogs")
  reported                Report[]                 @relation("ReportedUser")
  reports                 Report[]                 @relation("Reporter")
  notesAuthored           Note[]                   @relation("AuthorNotes")
  notesReceived           Note[]                   @relation("TargetUserNotes")
  profileVisits           ProfileVisit[]           @relation("VisitedUser")
  cart                    Cart?
  orders                  Order[]
  trainingVideoWatches    TrainingVideoWatch[]
  photos                  UserPhoto[]
  EmailVerificationToken  EmailVerificationToken[]
  blocking                Block[]                  @relation("UserBlocking")
  blockedBy               Block[]                  @relation("UserBlocked")
}

model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Appointment {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  userId              String?           @db.ObjectId
  professionalId      String            @db.ObjectId
  startTime           DateTime
  endTime             DateTime
  status              String            @default("upcoming")
  disputeStatus       String            @default("none")
  disputeReason       String?
  adminNotes          String?
  rate                Float?
  adjustedRate        Float?
  modificationHistory Json?
  venue               AppointmentVenue?
  createdAt           DateTime          @default(now())
  user                User?             @relation("UserAppointments", fields: [userId], references: [id], onDelete: SetNull)
  professional        Professional      @relation("ProfessionalAppointments", fields: [professionalId], references: [id], onDelete: Cascade)
  payment             Payment?
  videoSessions       VideoSession[]

  @@index([professionalId, startTime, endTime])
}

model Conversation {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId1   String     @db.ObjectId
  userId2   String     @db.ObjectId
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user1     User       @relation("User1Conversations", fields: [userId1], references: [id], onDelete: Cascade)
  user2     User       @relation("User2Conversations", fields: [userId2], references: [id], onDelete: Cascade)
  messages  Message[]  @relation("ConversationMessages")
  readBy    Json?
  Proposal  Proposal[] @relation
}

model Professional {
  id                   String     @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  image                String?
  rating               Float?
  reviewCount          Int?
  rate                 Float?
  biography            String?
  companyCutPercentage Float?
  venue                VenueType? @default(both)
  createdAt            DateTime   @default(now())
  location             String?

  appointments  Appointment[]             @relation("ProfessionalAppointments")
  applications  ProfessionalApplication[] @relation
  VideoSession  VideoSession[]
  availability  Availability[]            @relation
  profileVisits ProfileVisit[]            @relation("Visitee")
  Proposal      Proposal[]                @relation
  reviews       Review[]                  @relation("ProfessionalReviews")
  discounts     Discount[]                @relation
  reported      Report[]                  @relation("ReportedProfessional")
  notesReceived Note[]                    @relation("TargetProfessionalNotes")
}

model Post {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  content   String
  category  String
  authorId  String   @db.ObjectId
  author    User     @relation("UserPosts", fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  replies   Reply[]  @relation("PostReplies")
}

model Reply {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  content       String
  postId        String   @db.ObjectId
  authorId      String   @db.ObjectId
  parentReplyId String?  @db.ObjectId
  post          Post     @relation("PostReplies", fields: [postId], references: [id], onDelete: Cascade)
  author        User     @relation("UserReplies", fields: [authorId], references: [id], onDelete: Cascade)
  parentReply   Reply?   @relation("ReplyReplies", fields: [parentReplyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childReplies  Reply[]  @relation("ReplyReplies")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProfessionalApplication {
  id     String    @id @default(auto()) @map("_id") @db.ObjectId
  userId String    @unique @db.ObjectId
  rate   Float
  venue  VenueType

  status         ProOnboardingStatus @default(FORM_PENDING)
  submittedAt    DateTime?
  videoWatchedAt DateTime?
  quizPassedAt   DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  professional   Professional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)
  professionalId String?       @db.ObjectId

  quizAttempts ProQuizAttempt[]    @relation("ApplicationQuizAttempts")
  videoWatch   TrainingVideoWatch? @relation("ProOnboardingVideo")

  @@index([status])
  @@index([professionalId])
}

model ProQuizAttempt {
  id             String                  @id @default(auto()) @map("_id") @db.ObjectId
  applicationId  String                  @db.ObjectId
  score          Float
  passed         Boolean
  answers        Json
  attemptedAt    DateTime                @default(now())
  nextEligibleAt DateTime?
  application    ProfessionalApplication @relation("ApplicationQuizAttempts", fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([nextEligibleAt])
}

enum ProOnboardingStatus {
  FORM_PENDING
  FORM_SUBMITTED
  VIDEO_PENDING
  QUIZ_PENDING
  QUIZ_PASSED
  QUIZ_FAILED
  ADMIN_REVIEW
  APPROVED
  REJECTED
  SUSPENDED
}

model VideoSession {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Chime Meeting Info
  meetingId         String  @unique
  externalMeetingId String? @unique
  mediaRegion       String  @default("us-east-2")
  mediaPlacement    Json?

  // Participants
  userId         String @db.ObjectId
  professionalId String @db.ObjectId

  // Optional: Link to appointment (one-to-many now)
  appointmentId String? @db.ObjectId

  // Session Info
  scheduledStart DateTime?
  actualStart    DateTime?
  actualEnd      DateTime?
  duration       Int?

  // Status
  status    VideoSessionStatus @default(SCHEDULED)
  endReason String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  professional Professional    @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  appointment  Appointment?    @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  attendees    VideoAttendee[]

  @@index([status])
  @@index([scheduledStart])
  @@index([userId])
  @@index([professionalId])
  @@index([appointmentId])
}

model VideoAttendee {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  videoSessionId String @db.ObjectId

  // Chime Attendee Info
  attendeeId     String
  externalUserId String
  joinToken      String

  // Participant Info
  role        String @default("participant")
  displayName String

  // Tracking
  joinedAt DateTime?
  leftAt   DateTime?

  createdAt DateTime @default(now())

  // Relations
  videoSession VideoSession @relation(fields: [videoSessionId], references: [id], onDelete: Cascade)

  @@unique([videoSessionId, externalUserId])
  @@index([attendeeId])
}

enum VideoSessionStatus {
  SCHEDULED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  FAILED
}

model Availability {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  professionalId String       @db.ObjectId
  dayOfWeek      Int
  slots          String[]
  breakDuration  Int?         @default(30)
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek], name: "professionalId_dayOfWeek")
}

model ProfileVisit {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  userId         String        @db.ObjectId
  professionalId String?       @db.ObjectId
  visitedUserId  String?       @db.ObjectId
  createdAt      DateTime      @default(now())
  user           User          @relation("Visitor", fields: [userId], references: [id], onDelete: Cascade)
  professional   Professional? @relation("Visitee", fields: [professionalId], references: [id], onDelete: SetNull)
  visitedUser    User?         @relation("VisitedUser", fields: [visitedUserId], references: [id], onDelete: SetNull)
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  text           String
  isAudio        Boolean      @default(false)
  isSystem       Boolean      @default(false)
  imageUrl       String?
  senderId       String       @db.ObjectId
  recipientId    String       @db.ObjectId
  conversationId String       @db.ObjectId
  createdAt      DateTime     @default(now())
  proposalId     String?      @db.ObjectId
  senderUser     User         @relation("SentMessagesUser", fields: [senderId], references: [id], onDelete: Cascade)
  recipientUser  User         @relation("ReceivedMessagesUser", fields: [recipientId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  proposal       Proposal?    @relation(fields: [proposalId], references: [id], onDelete: SetNull)
}

model Proposal {
  id             String            @id @default(auto()) @map("_id") @db.ObjectId
  professionalId String            @db.ObjectId
  userId         String            @db.ObjectId
  conversationId String            @db.ObjectId
  startTime      DateTime?
  endTime        DateTime?
  venue          AppointmentVenue?
  status         String            @default("pending")
  initiator      String            @default("professional")
  createdAt      DateTime          @default(now())
  professional   Professional      @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation   Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  messages       Message[]         @relation

  @@index([professionalId, startTime, endTime])
}

model Review {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  professionalId String       @db.ObjectId
  reviewerId     String       @db.ObjectId
  rating         Int
  feedback       String
  createdAt      DateTime     @default(now())
  professional   Professional @relation("ProfessionalReviews", fields: [professionalId], references: [id], onDelete: Cascade)
  reviewer       User         @relation("UserReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
}

model Discount {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  professionalId String       @db.ObjectId
  name           String
  rate           Float
  discount       Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
}

model Payment {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  appointmentId String?      @unique @db.ObjectId
  orderId       String?      @unique @db.ObjectId
  amount        Float
  status        String       @default("pending")
  stripeId      String?
  createdAt     DateTime     @default(now())
  notes         String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  order         Order?       @relation("OrderPayment", fields: [orderId], references: [id], onDelete: Cascade)
}

model CompanySettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SurveyResponse {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  rating    Int
  feedback  String?
  createdAt DateTime @default(now())
  user      User     @relation("UserSurveys", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

model SecurityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  eventType String
  ipAddress String?
  details   String
  timestamp DateTime @default(now())
  user      User?    @relation("UserSecurityLogs", fields: [userId], references: [id], onDelete: SetNull)
}

model Report {
  id                     String        @id @default(auto()) @map("_id") @db.ObjectId
  reporterId             String        @db.ObjectId
  reportedUserId         String?       @db.ObjectId
  reportedProfessionalId String?       @db.ObjectId
  reason                 String
  details                String?
  status                 String        @default("pending")
  createdAt              DateTime      @default(now())
  reporter               User          @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser           User?         @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)
  reportedProfessional   Professional? @relation("ReportedProfessional", fields: [reportedProfessionalId], references: [id], onDelete: SetNull)
}

model Note {
  id                   String        @id @default(auto()) @map("_id") @db.ObjectId
  authorId             String        @db.ObjectId
  targetUserId         String?       @db.ObjectId
  targetProfessionalId String?       @db.ObjectId
  content              String
  createdAt            DateTime      @default(now())
  author               User          @relation("AuthorNotes", fields: [authorId], references: [id], onDelete: Cascade)
  targetUser           User?         @relation("TargetUserNotes", fields: [targetUserId], references: [id], onDelete: SetNull)
  targetProfessional   Professional? @relation("TargetProfessionalNotes", fields: [targetProfessionalId], references: [id], onDelete: SetNull)
}

// VenueType: Used for Professional's capability (can offer host, visit, or both)
enum VenueType {
  host
  visit
  both
}

// AppointmentVenue: Used for actual appointments (must be one specific venue)
enum AppointmentVenue {
  host
  visit
}

model Merchandise {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  image       String?
  stock       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[]
  cartItems   CartItem[]
}

model Cart {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String     @unique @db.ObjectId
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CartItem {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  cartId        String      @db.ObjectId
  merchandiseId String      @db.ObjectId
  quantity      Int
  cart          Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  merchandise   Merchandise @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)

  @@unique([cartId, merchandiseId])
}

model Order {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @db.ObjectId
  totalAmount Float
  status      String      @default("pending")
  stripeId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  payment     Payment?    @relation("OrderPayment")
}

model OrderItem {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String      @db.ObjectId
  merchandiseId String      @db.ObjectId
  quantity      Int
  price         Float
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  merchandise   Merchandise @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)
}

model TrainingVideo {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  url             String
  durationSec     Int?
  isActive        Boolean              @default(true)
  isProOnboarding Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  watches         TrainingVideoWatch[]

  @@index([isActive])
}

model TrainingVideoWatch {
  id             String                   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String                   @db.ObjectId
  videoId        String                   @db.ObjectId
  watchedSec     Int                      @default(0)
  isCompleted    Boolean                  @default(false)
  lastWatchedAt  DateTime                 @updatedAt
  applicationId  String?                  @unique @db.ObjectId
  user           User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video          TrainingVideo            @relation(fields: [videoId], references: [id], onDelete: Cascade)
  proApplication ProfessionalApplication? @relation("ProOnboardingVideo", fields: [applicationId], references: [id], onDelete: SetNull)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model UserPhoto {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  url       String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model RateLimitRecord {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String
  action      String
  count       Int      @default(1)
  windowStart DateTime @default(now())
  expiresAt   DateTime

  @@unique([key, action])
  @@index([expiresAt])
}

model Block {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  blockerId String   @db.ObjectId
  blockedId String   @db.ObjectId
  createdAt DateTime @default(now())

  blocker User @relation("UserBlocking", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("UserBlocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}
